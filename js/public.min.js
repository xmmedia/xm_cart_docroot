var cart_public_app={models:{},views:{},collections:{},ajax_action:function(action,data,options){options=options?_.clone(options):{};data=data?_.clone(data):{};var ajax_options=_.defaults(options,{url:"/"+cart_config.prefix+"/"+action,data:data,method:"POST",dataType:"JSON"}),xhr=$.ajax(ajax_options);options.done?xhr.done(options.done):xhr.done(this.ajax_promise);options.fail?xhr.fail(options.fail):xhr.fail(this.ajax_promise);return xhr},ajax_promise:function(return_data){cl4.process_ajax(return_data);cart_public_app.order_products.retrieve()}};cart_public_app.models.order=Backbone.Model.extend({});cart_public_app.models.order_product=Backbone.Model.extend({parse:function(resp,options){_.each(["id","cart_product_id","quantity"],function(field){typeof resp[field]!==undefined&&(resp[field]=parseInt(resp[field],0))});resp.unit_price=parseFloat(resp.unit_price);return resp}});cart_public_app.collections.order_products=Backbone.Collection.extend({model:cart_public_app.models.order_product,retrieve:function(){var collection=this;collection.reset();cart_public_app.router&&cart_public_app.cart&&cart_public_app.cart.loading();cart_public_app.ajax_action("load_cart",{},{done:function(return_data){if(cl4.process_ajax(return_data)){_.each(return_data.products,function(product){collection.add(product,{parse:!0})});cart_public_app.cart=(new cart_public_app.views.cart({collection:collection})).render()}else cart_public_app.cart.failed()},fail:function(return_data){cl4.process_ajax(return_data);cart_public_app.cart.failed()}});return this}});cart_public_app.views.add_product=Backbone.View.extend({events:{submit:"add_product"},add_product:function(e){e.preventDefault();cart_public_app.cart.loading();this.$('input[type="submit"]').prop("disabled",!0);cart_public_app.ajax_action("add_product",{cart_product_id:this.$el.find(".js_cart_product_id").val(),quantity:this.$el.find(".js_cart_order_product_quantity").val()},{context:this,done:this.ajax_promise,fail:this.ajax_promise})},ajax_promise:function(return_data){cl4.process_ajax(return_data);cart_public_app.order_products.retrieve();this.$('input[type="submit"]').prop("disabled",!1)}});cart_public_app.views.cart=Backbone.View.extend({el:$(".js_cart"),loading_template:Handlebars.compile('<img src="/images/loading.gif">'),cart_template:Handlebars.compile('<div class="cart"><table class="cart_product_list js_cart_product_list"><thead><tr><th class="col_name">Item</th><th class="col_quantity">Quantity</th><th class="col_unit_price">Unit Price</th><th class="col_amount">Amount</th><th class="col_remove"></th></tr></thead><tbody></tbody></table><p><a href="/{{cart_prefix}}/cart_empty" class="js_cart_empty">Empty Cart</a></p></div>'),error_template:Handlebars.compile("<p><em>{{error}}</em></p>"),events:{"click .js_cart_empty":"cart_empty"},loading:function(){this.$el.html(this.loading_template())},render:function(){if(this.collection.size()>0){this.$el.html(this.cart_template({cart_prefix:cart_config.prefix}));var table=this.$(".js_cart_product_list tbody");this.collection.forEach(function(order_product){table.append((new cart_public_app.views.cart_product({model:order_product})).render().el)})}else this.$el.html("<p><em>Your cart is currently empty.</em></p>");return this},cart_empty:function(e){e.preventDefault();this.loading();cart_public_app.ajax_action("cart_empty",{},{fail:function(return_data){cl4.process_ajax(return_data);this.$el.html(this.error_template({error:"There was a problem emptying your cart. Please try again later."}));setTimeout(function(){cart_public_app.order_products.retrieve()},2e3)}})},failed:function(){this.$el.html(this.error_template({error:"There was a problem loading your cart. Please try again later."}))}});cart_public_app.views.cart_product=Backbone.View.extend({tagName:"tr",template:Handlebars.compile('<td class="col_name">{{name}}</td><td class="col_quantity"><input type="text" size="3" maxlength="6" value="{{quantity}}" class="text_center js_cart_order_product_quantity"></td><td class="col_unit_price">{{unit_price_formatted}}</td><td class="col_amount">{{amount_formatted}}</td><td class="col_remove"><a href="/{{cart_prefix}}/remove_product" class="js_cart_order_product_remove">X</a></td>'),loading_div_template:Handlebars.compile('<div style="display: inline-block; text-align: center; width: 100%;"><img src="/images/loading.gif"></div>'),events:{"change .js_cart_order_product_quantity":"quantity_changed","click .js_cart_order_product_remove":"remove_product"},render:function(){var template_vars=_.clone(this.model.attributes);template_vars.cart_prefix=cart_config.prefix;this.$el.html(this.template(template_vars));return this},quantity_changed:function(e){this.$(".js_cart_order_product_quantity").replaceWith(this.loading_div_template());this.model.set("quantity",$(e.target).val());cart_public_app.ajax_action("change_quantity",{cart_order_product_id:this.model.get("id"),quantity:this.model.get("quantity")})},remove_product:function(e){e.preventDefault();cart_public_app.ajax_action("remove_product",{cart_order_product_id:this.model.get("id"),quantity:this.model.get("quantity")})}});cart_public_app.router=new(Backbone.Router.extend({el:$(".js_cart"),routes:{"":"index",product_list:"product_list"},initialize:function(){cart_public_app.order_products=(new cart_public_app.collections.order_products).retrieve()},start:function(){Backbone.history.start({pushState:!0,root:"/"+cart_config.prefix+"/"})},index:function(){},product_list:function(){_.each($(".js_cart_add_product"),function(el){new cart_public_app.views.add_product({el:el})})}}));$(function(){cart_public_app.router.start()});