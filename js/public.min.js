var cart_public_app={models:{},views:{},collections:{},ajax_action:function(action,data,options){options=options?_.clone(options):{};data=data?_.clone(data):{};var ajax_options=_.defaults(options,{url:"/"+cart_config.prefix+"/"+action,data:data,method:"POST",dataType:"JSON"}),xhr=$.ajax(ajax_options);options.done?xhr.done(options.done):xhr.done(this.ajax_promise);options.fail?xhr.fail(options.fail):xhr.fail(this.ajax_promise);return xhr},ajax_promise:function(return_data){cl4.process_ajax(return_data);cart_public_app.order_products.retrieve()}};cart_public_app.models.order=Backbone.Model.extend({parse:function(resp,options){_.each(["sub_total","total"],function(field){typeof resp[field]!==undefined&&(resp[field]=parseFloat(resp[field]))});return resp}});cart_public_app.models.order_product=Backbone.Model.extend({parse:function(resp,options){_.each(["id","cart_product_id","quantity"],function(field){typeof resp[field]!==undefined&&(resp[field]=parseInt(resp[field],0))});resp.unit_price=parseFloat(resp.unit_price);return resp}});cart_public_app.collections.order_products=Backbone.Collection.extend({model:cart_public_app.models.order_product,retrieve:function(){var collection=this;collection.reset();cart_public_app.router&&cart_public_app.cart&&cart_public_app.cart.loading();cart_public_app.ajax_action("load_cart",{},{done:function(return_data){if(cl4.process_ajax(return_data)){_.each(return_data.products,function(product){collection.add(product,{parse:!0})});cart_public_app.order=new cart_public_app.models.order(return_data.order);cart_public_app.totals=new cart_public_app.views.totals({model:cart_public_app.order});cart_public_app.cart=(new cart_public_app.views.cart({collection:collection,totals:cart_public_app.totals})).render()}else cart_public_app.cart.failed()},fail:function(return_data){cl4.process_ajax(return_data);cart_public_app.cart.failed()}});return this}});cart_public_app.views.add_product=Backbone.View.extend({events:{submit:"add_product"},add_product:function(e){e.preventDefault();cart_public_app.cart.loading();this.$('input[type="submit"]').prop("disabled",!0);cart_public_app.ajax_action("add_product",{cart_product_id:this.$el.find(".js_cart_product_id").val(),quantity:this.$el.find(".js_cart_order_product_quantity").val()},{context:this,done:this.ajax_promise,fail:this.ajax_promise})},ajax_promise:function(return_data){cl4.process_ajax(return_data);cart_public_app.order_products.retrieve();this.$('input[type="submit"]').prop("disabled",!1)}});cart_public_app.views.cart=Backbone.View.extend({el:$(".js_cart"),loading_template:Handlebars.compile('<img src="/images/loading.gif">'),cart_template:Handlebars.compile('<div class="cart"><table class="cart_product_list cart_product_list_editable js_cart_product_list"><thead><tr><th class="col_name">Item</th><th class="col_quantity">Quantity</th><th class="col_unit_price">Unit Price</th><th class="col_amount">Amount</th><th class="col_remove"></th></tr></thead><tbody></tbody></table><div class="cart_actions"><div class="cart_actions_left"><a href="/{{cart_prefix}}/cart_empty" class="js_cart_empty">Empty Cart</a></div><div class="cart_actions_right"><input type="button" value="Checkout" class="js_cart_checkout"></div></div></div>'),error_template:Handlebars.compile("<p><em>{{error}}</em></p>"),events:{"click .js_cart_empty":"cart_empty","click .js_cart_checkout":"start_checkout"},loading:function(){this.$el.html(this.loading_template())},render:function(){if(this.collection.size()>0){this.$el.html(this.cart_template({cart_prefix:cart_config.prefix}));var table=this.$(".js_cart_product_list tbody");this.collection.forEach(function(order_product){table.append((new cart_public_app.views.cart_product({model:order_product})).render().el)});table.append(this.options.totals.render().el.innerHTML)}else this.$el.html("<p><em>Your cart is currently empty.</em></p>");return this},cart_empty:function(e){e.preventDefault();this.loading();cart_public_app.ajax_action("cart_empty",{},{fail:function(return_data){cl4.process_ajax(return_data);this.$el.html(this.error_template({error:"There was a problem emptying your cart. Please try again later."}));setTimeout(function(){cart_public_app.order_products.retrieve()},2e3)}})},start_checkout:function(){window.location.href="/"+cart_config.prefix+"/checkout"},failed:function(){this.$el.html(this.error_template({error:"There was a problem loading your cart. Please try again later."}))}});cart_public_app.views.cart_product=Backbone.View.extend({tagName:"tr",template:Handlebars.compile('<td class="col_name">{{name}}</td><td class="col_quantity"><input type="text" size="3" maxlength="6" value="{{quantity}}" class="cart_order_product_quantity js_cart_order_product_quantity"><br><a href="" class="cart_order_product_update_quantity js_cart_order_product_update_quantity">Update</a></td><td class="col_unit_price">{{unit_price_formatted}}</td><td class="col_amount">{{amount_formatted}}</td><td class="col_remove"><a href="/{{cart_prefix}}/remove_product" class="js_cart_order_product_remove" title="Remove Item from Cart">X</a></td>'),loading_div_template:Handlebars.compile('<div style="display: inline-block; text-align: center; width: 100%;"><img src="/images/loading.gif"></div>'),events:{"change .js_cart_order_product_quantity":"quantity_changed","click .cart_order_product_update_quantity":"update_quantity","click .js_cart_order_product_remove":"remove_product"},render:function(){var template_vars=_.clone(this.model.attributes);template_vars.cart_prefix=cart_config.prefix;this.$el.html(this.template(template_vars));return this},quantity_changed:function(){this.model.set("quantity",this.$(".js_cart_order_product_quantity").val());this.$(".js_cart_order_product_quantity").replaceWith(this.loading_div_template());cart_public_app.ajax_action("change_quantity",{cart_order_product_id:this.model.get("id"),quantity:this.model.get("quantity")})},update_quantity:function(e){e.preventDefault();this.quantity_changed()},remove_product:function(e){e.preventDefault();cart_public_app.ajax_action("remove_product",{cart_order_product_id:this.model.get("id"),quantity:this.model.get("quantity")})}});cart_public_app.views.totals=Backbone.View.extend({total_template:Handlebars.compile('<tr class="total_row{{#if grand_total}} grand_total{{/if}}"><td class="col_name"></td><td class="col_unit_price" colspan="2">{{name}}</td><td class="col_amount">{{total}}</td><td class="col_remove"></td></tr>'),render:function(){var total_vars={name:"Sub Total",total:this.model.get("sub_total_formatted")};this.$el.append(this.total_template(total_vars));total_vars.name="Total";total_vars.total=this.model.get("total_formatted");total_vars.grand_total=!0;this.$el.append(this.total_template(total_vars));return this}});cart_public_app.views.checkout=Backbone.View.extend({checkout_box_error_template:Handlebars.compile('<ul class="cl4_message"><li class="error">{{error}}</li></ul>'),events:{"click .js_cart_checkout_continue":"next_step","click .js_cart_checkout_box_edit":"edit_step","click .js_cart_checkout_copy_shipping":"copy_shipping","change .js_cart_checkout_form_billing":"billing_changed"},initialize:function(){this.steps=this.$(".js_cart_checkout_step");_.each(this.steps,function(step){var _step=$(step);_step.data("cart_checkout_complete",0);_step.data("cart_checkout_step_type")!="cart"&&_step.data("cart_checkout_step_is_open",0)},this);this.current_step=this.$('.js_cart_checkout_step[data-cart_checkout_step_type="cart"]')},next_step:function(e){var step_container=$(e.target).closest(".js_cart_checkout_step"),allow_continue=this.validate_step(step_container);allow_continue&&this.goto_next_step(step_container)},goto_next_step:function(step_container){var checkout_view=this;step_container.find(".js_cart_checkout_box_open").data("cart_checkout_step_is_open",0).hide().promise().done(function(){step_container.find(".js_cart_checkout_box_closed").show().promise().done(function(){step_container.data("cart_checkout_complete",1);checkout_view.open_next_step(step_container)})})},open_next_step:function(current_step){var next_step_num=parseInt($(current_step).data("cart_checkout_step"),0)+1;for(i=next_step_num-1;i<this.steps.length;i++){var _step=$(this.steps[i]);if(_step.data("cart_checkout_complete")===0){this.open_step(_step);break}}},open_step:function(step_container){var view=this;this.current_step=step_container;step_container.find(".js_cart_checkout_box_closed").data("cart_checkout_step_is_open",1).hide().promise().done(function(){step_container.find(".js_cart_checkout_box_open").show();step_container.find(".js_cart_checkout_box_messages").empty();view.scroll_to(step_container)})},close_step:function(step_container){step_container.find(".js_cart_checkout_box_open").data("cart_checkout_step_is_open",0).hide().promise().done(function(){step_container.find(".js_cart_checkout_box_closed").show()})},edit_step:function(e){e.preventDefault();this.close_step(this.current_step);var step_container=$(e.target).closest(".js_cart_checkout_step");this.open_step(step_container)},copy_shipping:function(e){e.preventDefault();_.each(this.$(".js_cart_checkout_form_shipping input, .js_cart_checkout_form_shipping select"),function(field){var _field=$(field),field_name=_field.data("cart_shipping_field");if(field_name!=="phone")this.$('.js_cart_checkout_form_billing [data-cart_billing_field="'+field_name+'"]').val(_field.val());else{var name_parts=_field.attr("name").split("["),phone_part=name_parts[name_parts.length-1],phone_part_name=phone_part.substring(0,phone_part.length-1);this.$('.js_cart_checkout_form_billing input[name*="'+phone_part_name+'"]').val(_field.val())}},this);$(".js_cart_checkout_form_billing .js_cart_same_as_shipping_flag").val(1)},billing_changed:function(){$(".js_cart_checkout_form_billing .js_cart_same_as_shipping_flag").val(0)},validate_step:function(step_container){switch(step_container.data("cart_checkout_step_type")){case"cart":return this.validate_cart(step_container);case"shipping":return this.validate_shipping(step_container);case"payment":return this.validate_payment(step_container);case"confirm":return this.validate_confirm(step_container);default:return!1}},validate_cart:function(step_container){return!0},validate_shipping:function(step_container){this.add_loading(step_container);var verify_error="There was a problem verifying your shipping information. Please try again later.";step_container.find(".js_cart_checkout_form_shipping").ajaxForm({dataType:"JSON",context:this,success:function(return_data){if(cl4.process_ajax(return_data)){step_container.find(".js_cart_checkout_box_result").html(return_data.shipping_display);this.goto_next_step(step_container)}else{var message_html;return_data.message_html?message_html=return_data.message_html:message_html=this.checkout_box_error_template({error:verify_error});this.add_messages(step_container,message_html)}this.remove_loading(step_container)},error:function(){step_container.find(".js_cart_checkout_box_messages").html(this.checkout_box_error_template({error:verify_error}));this.remove_loading(step_container)}}).submit();return!1},validate_payment:function(step_container){this.add_loading(step_container);var verify_error="There was a problem verifying your billing and payment information. Please try again later.";step_container.find(".js_cart_checkout_form_billing").ajaxForm({dataType:"JSON",context:this,success:function(return_data){if(cl4.process_ajax(return_data))step_container.find(".js_cart_checkout_form_payment").ajaxForm({dataType:"JSON",context:this,success:function(return_data){if(cl4.process_ajax(return_data)){step_container.find(".js_cart_checkout_box_result").html(return_data.billing_display);this.goto_next_step(step_container)}else{var message_html;return_data.message_html?message_html=return_data.message_html:message_html=this.checkout_box_error_template({error:verify_error});this.add_messages(step_container,message_html)}this.remove_loading(step_container)},error:function(){step_container.find(".js_cart_checkout_box_messages").html(this.checkout_box_error_template({error:verify_error}));this.remove_loading(step_container)}}).submit();else{var message_html;return_data.message_html?message_html=return_data.message_html:message_html=this.checkout_box_error_template({error:verify_error});this.add_messages(step_container,message_html)}this.remove_loading(step_container)},error:function(){step_container.find(".js_cart_checkout_box_messages").html(this.checkout_box_error_template({error:verify_error}));this.remove_loading(step_container)}}).submit();return!1},validate_confirm:function(step_container){return!0},add_loading:function(step_container){step_container.find(".js_cart_checkout_continue").before('<img src="/images/loading.gif" class="js_loading">')},remove_loading:function(step_container){step_container.find(".js_loading").remove()},add_messages:function(step_container,message_html){step_container.find(".js_cart_checkout_box_messages").html(message_html);this.scroll_to(step_container)},scroll_to:function(element){$("html, body").animate({scrollTop:element.offset().top},500)}});cart_public_app.router=new(Backbone.Router.extend({el:$(".js_cart"),routes:{checkout:"checkout",product_list:"product_list"},start:function(){Backbone.history.start({pushState:!0,root:"/"+cart_config.prefix+"/"})},checkout:function(){cart_public_app.checkout=new cart_public_app.views.checkout({el:$(".js_cart_checkout")})},product_list:function(){this.load_cart();_.each($(".js_cart_add_product"),function(el){new cart_public_app.views.add_product({el:el})})},load_cart:function(){cart_public_app.order_products=(new cart_public_app.collections.order_products).retrieve()}}));$(function(){cart_public_app.router.start()});