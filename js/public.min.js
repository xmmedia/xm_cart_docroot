var cart_public_app={models:{},views:{},collections:{}};Backbone.emulateHTTP=!0;Backbone.emulateJSON=!0;cart_public_app.models.order=Backbone.Model.extend({});cart_public_app.models.order_product=Backbone.Model.extend({urlRoot:"save_product",parse:function(resp,options){_.each(["id","cart_product_id","quantity"],function(field){resp[field]&&(resp[field]=parseInt(resp[field],0))});resp.unit_price=parseFloat(resp.unit_price);return resp}});cart_public_app.collections.order_products=Backbone.Collection.extend({model:cart_public_app.models.order_product,url:"load_products"});cart_public_app.views.add_product=Backbone.View.extend({events:{submit:"add_product"},add_product:function(e){e.preventDefault();var cart_product_id=parseInt(this.$el.find(".js_cart_product_id").val(),0),quantity=parseInt(this.$el.find(".js_cart_order_product_quantity").val(),0),existing=cart_public_app.router.order_products.findWhere({cart_product_id:cart_product_id});existing?existing.set("quantity",existing.get("quantity")+quantity):cart_public_app.router.order_products.add([{cart_product_id:cart_product_id,quantity:quantity}])}});cart_public_app.views.cart=Backbone.View.extend({el:$(".js_cart"),loading_template:Handlebars.compile('<img src="/images/loading.gif">'),cart_template:Handlebars.compile('<div class="cart"><ul class="js_cart_product_list"></ul><p><a href="/{{cart_prefix}}/cart_empty" class="js_cart_empty">Empty Cart</a></p></div>'),events:{"click .js_cart_empty":"cart_empty"},initialize:function(){this.collection.on("fetch",this.loading,this);this.collection.on("change",this.change,this);this.collection.on("add",this.change,this);this.collection.on("destroy",this.render,this);this.collection.on("reset",this.cart_reset,this)},loading:function(){this.$el.html(this.loading_template())},change:function(model){model.save();this.render()},render:function(){if(this.collection.size()>0){this.$el.html(this.cart_template({cart_prefix:cart_config.prefix}));var ul=this.$(".js_cart_product_list");this.collection.forEach(function(order_product){ul.append((new cart_public_app.views.cart_product({model:order_product})).render().el)})}else this.$el.html("<p><em>Your cart is currently empty.</em></p>");return this},cart_empty:function(e){e.preventDefault();this.collection.reset()},cart_reset:function(collection){if(collection.size()===0){this.loading();$.ajax({url:"/"+cart_config.prefix+"/cart_empty",dataType:"JSON",context:this}).done(function(){this.render()}).fail(function(){this.$el.html("<p><em>There was a problem emptying your cart. Please try again later.</em></p>");var view=this;setTimeout(function(){view.render()},2e3)})}else this.render()}});cart_public_app.views.cart_product=Backbone.View.extend({tagName:"li",template:Handlebars.compile('{{name}} <input type="text" size="3" maxlength="6" value="{{quantity}}" class="text_right js_cart_order_product_quantity"> x {{cost_formatted}} <a href="/{{cart_prefix}}/remove_product" class="js_cart_order_product_remove">Remove</a>'),events:{"change .js_cart_order_product_quantity":"quantity_changed","click .js_cart_order_product_remove":"remove_product"},render:function(){var template_vars=this.model.attributes;template_vars.cart_prefix=cart_config.prefix;this.$el.html(this.template(template_vars));return this},quantity_changed:function(e){var quantity=parseInt($(e.target).val(),0);quantity>0?this.model.set("quantity",quantity):this.remove_product()},remove_product:function(e){e&&e.preventDefault();this.model.destroy()}});cart_public_app.router=new(Backbone.Router.extend({el:$(".js_cart"),routes:{"":"index",product_list:"product_list"},initialize:function(){this.order_products=new cart_public_app.collections.order_products;this.order_products.fetch({context:this,success:function(){cart_public_app.router.cart=(new cart_public_app.views.cart({collection:cart_public_app.router.order_products})).render()}})},start:function(){Backbone.history.start({pushState:!0,root:"/"+cart_config.prefix+"/"})},index:function(){},product_list:function(){_.each($(".js_cart_add_product"),function(el){new cart_public_app.views.add_product({el:el})})}}));$(function(){cart_public_app.router.start()});