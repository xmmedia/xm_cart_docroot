var cart_public_app={models:{},views:{},collections:{},has_summary:!1,has_cart:!1,ajax_action:function(action,data,options){options=options?_.clone(options):{},data=data?_.clone(data):{},data.c_ajax=1;var ajax_options=_.defaults(options,{url:"/"+cart_config.route_prefix+"/"+action,data:data,method:"POST",dataType:"JSON"}),xhr=$.ajax(ajax_options);return xhr.done(options.done?options.done:this.ajax_promise),xhr.fail(options.fail?options.fail:this.ajax_promise),xhr},ajax_promise:function(return_data){xm.process_ajax(return_data),cart_public_app.update_cart()},update_cart:function(){cart_public_app.has_summary&&cart_public_app.summary.retrieve(),cart_public_app.order_products_summary&&cart_public_app.order_products_summary.retrieve(),cart_public_app.has_cart&&cart_public_app.order_products.retrieve()},start_checkout:function(){var cart_uri="/"+cart_config.route_prefix+"/checkout";cart_config.checkout_https&&"http:"==window.location.protocol?window.location="https://"+window.location.host+cart_uri:window.location.href=cart_uri},loading_template:Handlebars.compile('<span class="js_loading">'+xm.spinner+"</span>"),empty_cart_template:Handlebars.compile('<div class="cart_empty_msg">Your cart is currently empty.</div>'),error_template:Handlebars.compile('<div class="cart_error_msg">{{error}}</div>'),cart_product_list_template:'<table class="cart_product_list cart_product_list_editable js_cart_product_list"><thead><tr><th class="col_name">Item</th><th class="col_quantity">Quantity</th><th class="col_unit_price">Unit Price</th><th class="col_amount">Amount</th><th class="col_remove"></th></tr></thead><tbody></tbody></table>',cart_donation_list_template:'<table class="cart_product_list cart_product_list_editable js_cart_product_list"><thead><tr><th class="col_name"></th><th class="col_amount">Amount</th></tr></thead><tbody></tbody></table>'};try{Stripe.setPublishableKey(cart_config.stripe_publishable_key)}catch(e){}cart_public_app.models.order=Backbone.Model.extend({}),cart_public_app.models.order_product=Backbone.Model.extend({parse:function(resp){return _.each(["id","cart_product_id","quantity"],function(field){void 0!==typeof resp[field]&&(resp[field]=parseInt(resp[field],10))}),resp.unit_price=parseFloat(resp.unit_price),resp.amount=parseFloat(resp.amount),resp}}),cart_public_app.models.total=Backbone.Model.extend({parse:function(resp){return _.each(["value"],function(field){void 0!==typeof resp[field]&&(resp[field]=parseFloat(resp[field]))}),resp}}),cart_public_app.collections.order_products=Backbone.Collection.extend({model:cart_public_app.models.order_product,retrieve:function(){if(!cart_public_app.has_cart)return this;var collection=this;return collection.reset(),cart_public_app.router&&cart_public_app.cart&&cart_public_app.cart.loading(),cart_public_app.ajax_action("load_cart",{},{done:function(return_data){xm.process_ajax(return_data)?(_.each(return_data.products,function(product){collection.add(product,{parse:!0})}),cart_public_app.order=new cart_public_app.models.order(return_data.order),cart_public_app.totals=new cart_public_app.collections.totals(return_data.total_rows,{parse:!0}),cart_public_app.view_totals=new cart_public_app.views.totals({collection:cart_public_app.totals,order:cart_public_app.order}),cart_public_app.cart&&cart_public_app.cart.undelegateEvents(),cart_public_app.cart=new cart_public_app.views.cart({collection:collection,order:cart_public_app.order,view_totals:cart_public_app.view_totals}).render()):cart_public_app.cart?cart_public_app.cart.failed():cart_public_app.order_products.failed()},fail:function(return_data){xm.process_ajax(return_data),cart_public_app.cart?cart_public_app.cart.failed():cart_public_app.order_products.failed()}}),this},failed:function(){$(".js_cart").html(cart_public_app.error_template({error:"There was a problem loading your cart. Please try again later."}))}}),cart_public_app.collections.order_products_summary=Backbone.Collection.extend({model:cart_public_app.models.order_product,retrieve:function(){if(!cart_public_app.has_summary)return this;var collection=this;return collection.reset(),cart_public_app.router&&cart_public_app.summary_details&&(cart_public_app.summary_details.loading(),cart_public_app.ajax_action("load_cart",{},{done:function(return_data){xm.process_ajax(return_data)?(_.each(return_data.products,function(product){collection.add(product,{parse:!0})}),cart_public_app.summary_order=new cart_public_app.models.order(return_data.order),cart_public_app.summary_totals=new cart_public_app.collections.totals(return_data.total_rows,{parse:!0}),cart_public_app.summary_view_totals=new cart_public_app.views.totals({collection:cart_public_app.summary_totals,order:cart_public_app.summary_order}),cart_public_app.summary_details.set_data({collection:collection,order:cart_public_app.summary_order,view_totals:cart_public_app.summary_view_totals}).render()):cart_public_app.summary_details?cart_public_app.summary_details.failed():cart_public_app.order_products.failed()},fail:function(return_data){xm.process_ajax(return_data),cart_public_app.summary_details?cart_public_app.summary_details.failed():cart_public_app.order_products.failed()}})),this},failed:function(){$(".js_cart").html(cart_public_app.error_template({error:"There was a problem loading your cart. Please try again later."}))}}),cart_public_app.collections.totals=Backbone.Collection.extend({model:cart_public_app.models.total}),cart_public_app.views.add_product=Backbone.View.extend({events:{submit:"add_product"},add_product:function(e){e.preventDefault(),cart_public_app.summary.loading(),this.$('input[type="submit"]').prop("disabled",!0),cart_public_app.ajax_action("add_product",{cart_product_id:this.$el.find(".js_cart_product_id").val(),quantity:this.$el.find(".js_cart_order_product_quantity").val()},{context:this,done:this.ajax_promise,fail:this.ajax_promise})},ajax_promise:function(return_data){xm.process_ajax(return_data),cart_public_app.update_cart(),cart_public_app.summary.open_summary_details(),this.$('input[type="submit"]').prop("disabled",!1)}}),cart_public_app.views.cart=Backbone.View.extend({el:$(".js_cart"),cart_template:Handlebars.compile('<div class="cart">{{{product_table}}}<div class="cart_actions"><div class="cart_actions_left"><div class="location_select">{{#if show_shipping_location_msg}}Current Shipping Location: <span class="js_cart_shipping_location js_location_select">{{#if shipping_state}}{{shipping_state}}, {{/if}}{{shipping_country}} <a href="" class="js_cart_shipping_location_change">Change</a></span>{{else}}{{location_select_msg}}<br><span class="js_location_select">{{{country_select}}}</span>{{/if}}</div><a href="{{continue_shopping_url}}">Continue Shopping</a><a href="/{{cart_route_prefix}}/cart_empty" class="js_cart_empty">Empty Cart</a></div><div class="cart_actions_right"><button class="js_cart_checkout">Checkout</button></div></div></div>'),shipping_country_select_template:Handlebars.compile('<select name="" class="cart_location_country_id js_cart_location_country_id"><option value="">-- Select Your Shipping Country --</option>{{#each countries}}<option value="{{id}}">{{name}}</option>{{/each}}</select>'),shipping_state_select_template:Handlebars.compile('<select name="" class="cart_location_state_id js_cart_location_state_id"><option value="">{{shipping_select_default_option}}</option>{{#each states}}<option value="{{id}}">{{name}}</option>{{/each}}</select>'),shipping_select_default_option:"-- Select Your Shipping Province/State --",location_select_msgs:{both:"To calculate taxes and shipping, select your shipping location:",only_shipping:"To calculate shipping, select your shipping location:",only_tax:"To calculate taxes, select your shipping location:"},events:{"click .js_cart_empty":"cart_empty","click .js_cart_checkout":"start_checkout","change .js_cart_location_country_id":"change_country","change .js_cart_location_state_id":"change_state","click .js_cart_shipping_location_change":"change_shipping_location"},initialize:function(options){this.options=options||{}},loading:function(){this.$el.html(xm.spinner)},render:function(){if(this.collection.size()>0){var location_select_msg,country_select,show_shipping_location_msg=cart_config.enable_shipping&&!this.options.order.get("show_location_select");show_shipping_location_msg||(cart_config.enable_shipping&&cart_config.enable_tax?location_select_msg=this.location_select_msgs.both:cart_config.enable_shipping?location_select_msg=this.location_select_msgs.only_shipping:cart_config.enable_tax&&(location_select_msg=this.location_select_msgs.only_tax),cart_config.show_shipping_country&&(country_select=this.shipping_country_select_template({countries:cart_config.countries}))),this.$el.html(this.cart_template({cart_route_prefix:cart_config.route_prefix,continue_shopping_url:cart_config.continue_shopping_url,show_shipping_location_msg:show_shipping_location_msg,location_select_msg:location_select_msg,country_select:country_select,shipping_country:this.options.order.get("shipping_country"),shipping_state:this.options.order.get("shipping_state"),product_table:this.options.order.get("donation_cart")?cart_public_app.cart_donation_list_template:cart_public_app.cart_product_list_template}));var table=this.$(".js_cart_product_list tbody");this.collection.forEach(function(order_product){table.append(new cart_public_app.views.cart_product({model:order_product,donation_cart:this.options.order.get("donation_cart")}).render().el)},this),table.append(this.options.view_totals.render().el.innerHTML),show_shipping_location_msg||cart_config.show_shipping_country||this.change_country(cart_config.default_country_id)}else this.$el.html(cart_public_app.empty_cart_template());return this},cart_empty:function(e){e.preventDefault(),this.loading(),this.undelegateEvents(),cart_public_app.ajax_action("cart_empty",{},{context:this,fail:function(return_data){xm.process_ajax(return_data),this.failed(),setTimeout(function(){cart_public_app.update_cart()},2e3)}})},start_checkout:function(){cart_public_app.start_checkout()},failed:function(){this.$el.html(cart_public_app.error_template({error:"There was a problem loading your cart. Please try again later."}))},change_country:function(country_id){if(cart_config.enable_shipping){if(0==arguments.length)var country_id=this.$(".js_cart_location_country_id").val();country_id&&(this.add_location_loading(),cart_public_app.ajax_action("set_shipping_country",{country_id:country_id},{context:this,done:function(return_data){xm.process_ajax(return_data)&&return_data.show_state_select?(this.$(".js_location_select").append(this.shipping_state_select_template({states:return_data.states,shipping_select_default_option:this.shipping_select_default_option})),this.$(".js_loading").remove()):cart_public_app.update_cart()}}))}},change_state:function(){if(cart_config.enable_shipping){var state_id=this.$(".js_cart_location_state_id").val();state_id&&(this.add_location_loading(),cart_public_app.ajax_action("set_shipping_state",{state_id:state_id}))}},add_location_loading:function(){this.$(".js_location_select").append(cart_public_app.loading_template())},change_shipping_location:function(e){e.preventDefault(),cart_config.enable_shipping&&(cart_config.show_shipping_country?this.$(".js_cart_shipping_location").html("<br>"+this.shipping_country_select_template({countries:cart_config.countries})):this.change_country(cart_config.default_country_id))}}),cart_public_app.views.cart_product=Backbone.View.extend({tagName:"tr",template:Handlebars.compile('<td class="col_name js_col_name" data-view-url="{{view_url}}">{{#if show_product_photo}}<div class="photo"><img src="{{photo_uri}}"></div>{{/if}}<span class="name">{{name}}</span>{{#if description}}<div class="product_description">{{description}}</div>{{/if}}{{#if show_inventory}}<div class="inventory_available {{#if limited_quantity}}limited_quantity{{else}}in_stock{{/if}}">Available: {{inventory_available}}</div>{{/if}}</td><td class="col_quantity"><input type="text" size="3" maxlength="6" value="{{quantity}}" class="cart_order_product_quantity js_cart_order_product_quantity"><br><a href="" class="cart_order_product_update_quantity js_cart_order_product_update_quantity">Update</a></td><td class="col_unit_price">{{unit_price_formatted}}</td><td class="col_amount">{{amount_formatted}}</td><td class="col_remove"><a href="/{{cart_route_prefix}}/remove_product" class="js_cart_order_product_remove" title="Remove Item from Cart">X</a></td>'),donation_template:Handlebars.compile('<td class="col_name">{{name}}{{#if description}}<div class="product_description">{{description}}</div>{{/if}}</td><td class="col_amount">{{amount_formatted}}</td>'),loading_div_template:Handlebars.compile('<div class="cart_product_loading_container">'+cart_public_app.loading_template()+"</div>"),events:{"change .js_cart_order_product_quantity":"quantity_changed","click .cart_order_product_update_quantity":"update_quantity","click .js_cart_order_product_remove":"remove_product","click .js_col_name":"view_product"},initialize:function(options){this.options||(this.options={}),this.options.donation_cart=options.donation_cart},render:function(){var template_vars=_.clone(this.model.attributes);return template_vars.cart_route_prefix=cart_config.route_prefix,template_vars.show_product_photo=cart_config.show_product_photo,template_vars.show_inventory=cart_config.show_inventory,template_vars.limited_quantity=this.model.get("quantity")>this.model.get("inventory_available"),this.$el.html(this.options.donation_cart?this.donation_template(template_vars):this.template(template_vars)),this},quantity_changed:function(){var quantity_field=this.$(".js_cart_order_product_quantity");quantity_field.length>0&&(this.model.set("quantity",quantity_field.val()),this.$(".js_cart_order_product_quantity").replaceWith(this.loading_div_template()),cart_public_app.ajax_action("change_quantity",{cart_order_product_id:this.model.get("id"),quantity:this.model.get("quantity")}))},update_quantity:function(e){e.preventDefault(),this.quantity_changed()},remove_product:function(e){e.preventDefault(),cart_public_app.ajax_action("remove_product",{cart_order_product_id:this.model.get("id"),quantity:this.model.get("quantity")})},view_product:function(){window.location=this.$el.find(".js_col_name").data("view-url")}}),cart_public_app.views.checkout=Backbone.View.extend({error_template:Handlebars.compile('<ul class="xm_message"><li class="error">{{error}}</li></ul>'),payment_error_template:Handlebars.compile('<ul class="xm_message"><li class="error">Please fix the following:<ul class="xm_message_validation">{{#each msgs}}<li>{{this}}</li>{{/each}}</ul></li></ul>'),payment_display_template:Handlebars.compile("<p><strong>Payment Method</strong><br>{{card_type}} ...{{last_4}}</p>"),complete_loading_template:Handlebars.compile('<div class="js_loading">'+xm.spinner+"</div>"),totals_template:Handlebars.compile('<table class="cart_product_list js_cart_total_rows"><tbody></tbody></table>'),total_row_template:Handlebars.compile('<tr class="total_row{{#if is_grand_total}} grand_total{{/if}}"><td class="col_name"></td><td class="col_unit_price" colspan="2">{{name}}</td><td class="col_amount">{{value_formatted}}</td></tr>'),events:{"click .js_cart_checkout_continue":"next_step","click .js_cart_checkout_box_edit":"edit_step","click .js_cart_product_list":"view_product","click .js_cart_checkout_copy_shipping":"copy_shipping","change .js_cart_checkout_form_billing":"billing_changed","keyup .js_cart_checkout_credit_card_number":"display_card_type","click .js_cart_checkout_complete_order_submit":"complete_order","click .js_cart_add_shipping_test_values":"add_shipping_test_values","click .js_cart_add_billing_test_values":"add_billing_test_values","change .js_cart_add_credit_card_test_values":"add_credit_card_test_values"},total_rows:{},stripe_data:{},processing:!1,initialize:function(){try{if(!Stripe)throw new Exception("No Stripe")}catch(e){return alert("There was a problem loading the checkout page. Please try beginning the checkout process again."),void(window.location=cart_config.cart_view_url)}this.total_rows=cart_preload.total_rows,this.steps=this.$(".js_cart_checkout_step"),_.each(this.steps,function(step){var _step=$(step);_step.data("cart_checkout_complete",0)},this),this.current_step=this.$('.js_cart_checkout_step[data-cart_checkout_step_type="cart"]'),this.populate_total_rows()},populate_total_rows:function(total_rows){1==arguments.length&&(this.total_rows=total_rows),this.$(".js_cart_totals").empty().append(this.totals_template());var table=this.$(".js_cart_total_rows tbody");_.each(this.total_rows,function(total_row){table.append(this.total_row_template(total_row))},this)},next_step:function(e){var step_container=$(e.target).closest(".js_cart_checkout_step"),allow_continue=this.validate_step(step_container);this.processing||allow_continue&&this.goto_next_step(step_container)},goto_next_step:function(step_container){var checkout_view=this;step_container.find(".js_cart_checkout_box_open").hide().promise().done(function(){step_container.find(".js_cart_checkout_box_closed").show().promise().done(function(){step_container.data("cart_checkout_complete",1),checkout_view.open_next_step(step_container)})})},open_next_step:function(current_step){var next_step_num=parseInt($(current_step).data("cart_checkout_step"),10)+1;for(i=next_step_num-1;i<this.steps.length;i++){var _step=$(this.steps[i]);if(0===_step.data("cart_checkout_complete")){this.open_step(_step),this.show_cart_totals(_step);break}}},open_step:function(step_container){var view=this;this.current_step=step_container,step_container.find(".js_cart_checkout_box_closed").hide().promise().done(function(){step_container.find(".js_cart_checkout_box_open").show(),view.clear_messages(step_container),view.scroll_to(step_container),view.show_cart_totals(step_container)})},close_step:function(step_container){step_container.find(".js_cart_checkout_box_open").hide().promise().done(function(){step_container.find(".js_cart_checkout_box_closed").show()})},edit_step:function(e){if(e.preventDefault(),!this.processing){this.close_step(this.current_step);var step_container=$(e.target).closest(".js_cart_checkout_step");this.open_step(step_container)}},show_cart_totals:function(step_container){"confirm"==step_container.data("cart_checkout_step_type")?this.$(".js_cart_totals_outside").hide():this.$(".js_cart_totals_outside").show()},complete_order:function(e){if(e.preventDefault(),!this.processing){var button=$(e.target),step_container=button.closest(".js_cart_checkout_step"),verify_error="There was a problem processing your payment. Please contact us before trying again to prevent duplicate payments.";this.processing=!0,this.clear_messages(step_container),button.prop("disabled",!0),this.$(".js_cart_checkout_box_edit").css("visibility","hidden"),button.after(this.complete_loading_template()),this.$(".js_cart_checkout_stripe_token").val(this.stripe_data.id),this.$(".js_cart_checkout_form_complete_order").ajaxForm({dataType:"JSON",context:this,success:function(return_data){if(xm.process_ajax(return_data)&&"success"==return_data.payment_status)window.location="/"+cart_config.route_prefix+"/completed"+(return_data.is_donation_cart?"?is_donation_cart=1":"");else{if(return_data.redirect)return void(window.location=return_data.redirect);"fail"==return_data.payment_status&&(window.location="/"+cart_config.route_prefix+"/payment_failed"),button.prop("disabled",!1);var payment_step=this.$('.js_cart_checkout_step[data-cart_checkout_step_type="payment"]');this.close_step(step_container),payment_step.data("cart_checkout_complete",0),this.open_step(payment_step);var message_html;message_html=return_data.message_html?return_data.message_html:this.error_template({error:verify_error}),this.add_messages(payment_step,message_html),this.stop_processing(this,step_container)}},error:function(){step_container.find(".js_cart_checkout_box_messages").html(this.error_template({error:verify_error})),this.stop_processing(this,step_container),button.prop("disabled",!1)}}).submit()}},copy_shipping:function(e){e.preventDefault(),cart_config.enable_shipping&&(this.processing||(_.each(this.$(".js_cart_checkout_form_shipping input, .js_cart_checkout_form_shipping select"),function(field){var _field=$(field),field_name=_field.data("cart_shipping_field");if("phone"!==field_name)this.$('.js_cart_checkout_form_billing [data-cart_billing_field="'+field_name+'"]').val(_field.val());else{var name_parts=_field.attr("name").split("["),phone_part=name_parts[name_parts.length-1],phone_part_name=phone_part.substring(0,phone_part.length-1);this.$('.js_cart_checkout_form_billing input[name*="'+phone_part_name+'"]').val(_field.val())}},this),this.$(".js_cart_checkout_form_billing .js_cart_same_as_shipping_flag").val(1),"ontouchstart"in document.documentElement||this.$(".js_cart_checkout_credit_card_number").focus()))},billing_changed:function(){$(".js_cart_checkout_form_billing .js_cart_same_as_shipping_flag").val(0)},display_card_type:function(e){console.log(Stripe.card.cardType($(e.target).val()))},validate_step:function(step_container){switch(step_container.data("cart_checkout_step_type")){case"cart":return this.validate_cart(step_container);case"shipping":return this.validate_shipping(step_container);case"payment":return this.validate_payment(step_container);case"final":return this.validate_final(step_container);default:return!1}},validate_cart:function(){return!0},validate_shipping:function(step_container){if(cart_config.enable_shipping){this.start_processing(this,step_container),this.clear_messages(step_container);var verify_error="There was a problem verifying your shipping information. Please try again later.";return step_container.find(".js_cart_checkout_form_shipping").ajaxForm({dataType:"JSON",context:this,success:function(return_data){if(xm.process_ajax(return_data))step_container.find(".js_cart_checkout_box_result").html(return_data.shipping_display),this.populate_total_rows(return_data.total_rows),this.goto_next_step(step_container);else if(this.display_error_msgs(return_data,step_container,verify_error)===!1)return;this.stop_processing(this,step_container)},error:function(){step_container.find(".js_cart_checkout_box_messages").html(this.error_template({error:verify_error})),this.stop_processing(this,step_container)}}).submit(),!1}},validate_payment:function(step_container){this.start_processing(this,step_container),this.clear_messages(step_container);var verify_error="There was a problem verifying your billing and payment information. Please try again later.";return step_container.find(".js_cart_checkout_form_billing").ajaxForm({dataType:"JSON",context:this,success:function(return_data){if(xm.process_ajax(return_data)){var payment_form=step_container.find(".js_cart_checkout_form_payment"),credit_card={number:payment_form.find(".js_cart_checkout_credit_card_number").val(),security_code:payment_form.find(".js_cart_checkout_credit_card_security_code").val(),expiry_month:payment_form.find(".js_cart_checkout_credit_card_expiry_date_month").val(),expiry_year:payment_form.find(".js_cart_checkout_credit_card_expiry_date_year").val()},validation_msgs=[];Stripe.card.validateCardNumber(credit_card.number)||validation_msgs.push("Your Credit Card Number does not appear to be valid."),Stripe.card.validateCVC(credit_card.security_code)||validation_msgs.push("The Security Code does not appear to be valid."),Stripe.card.validateExpiry(credit_card.expiry_month,credit_card.expiry_year)||validation_msgs.push("The Expiry Date does not appear to be valid. Please confirm that the credit has not already expired."),validation_msgs.length>0?(this.add_messages(step_container,this.payment_error_template({msgs:validation_msgs})),this.stop_processing(this,step_container)):(step_container.find(".js_cart_checkout_box_result").html(return_data.billing_display),this.populate_total_rows(return_data.total_rows),Stripe.card.createToken({number:credit_card.number,cvc:credit_card.security_code,exp_month:credit_card.expiry_month,exp_year:credit_card.expiry_year,name:return_data.billing_address.first_name+" "+return_data.billing_address.last_name,address_line1:return_data.billing_address.address_1,address_line2:return_data.billing_address.address_2,address_city:return_data.billing_address.municipality,address_state:return_data.billing_address.state,address_zip:return_data.billing_address.postal_code,address_country:return_data.billing_address.country},this.stripe_response_handler))}else{if(this.display_error_msgs(return_data,step_container,verify_error)===!1)return;this.stop_processing(this,step_container)}},error:function(){step_container.find(".js_cart_checkout_box_messages").html(this.error_template({error:verify_error})),this.stop_processing(this,step_container)}}).submit(),!1},stripe_response_handler:function(status,response){var step_container=cart_public_app.checkout.current_step;response.error?(this.add_messages(step_container,this.error_template({error:response.error.message})),step_container.find(".js_cart_checkout_box_result").empty()):(cart_public_app.checkout.stripe_data=response,payment_display=cart_public_app.checkout.payment_display_template({card_type:response.card.type,last_4:response.card.last4}),step_container.find(".js_cart_checkout_box_result .js_cart_checkout_payment_display").html(payment_display),cart_public_app.checkout.stop_processing(cart_public_app.checkout,step_container),cart_public_app.checkout.goto_next_step(step_container))},validate_final:function(step_container){this.start_processing(this,step_container),this.clear_messages(step_container);var verify_error="There was a problem saving your order. Please try again later.";return step_container.find(".js_cart_checkout_form_final").ajaxForm({dataType:"JSON",context:this,success:function(return_data){if(xm.process_ajax(return_data))step_container.find(".js_cart_checkout_box_result").html(return_data.final_display),this.populate_total_rows(return_data.total_rows),this.goto_next_step(step_container);else if(this.display_error_msgs(return_data,step_container,verify_error)===!1)return;this.stop_processing(this,step_container)},error:function(){step_container.find(".js_cart_checkout_box_messages").html(this.error_template({error:verify_error})),this.stop_processing(this,step_container)}}).submit(),!1},start_processing:function(view,step_container){view.processing=!0,step_container.find('input[type="button"], button').prop("disabled",!0),view.$(".js_cart_checkout_box_edit").css("visibility","hidden"),step_container.find(".js_cart_checkout_continue").before(cart_public_app.loading_template()),step_container.find(".js_cart_checkout_complete_order_submit").after(cart_public_app.loading_template())},stop_processing:function(view,step_container){view.processing=!1,step_container.find('input[type="button"], button').prop("disabled",!1),view.$(".js_cart_checkout_box_edit").css("visibility","visible"),step_container.find(".js_loading").remove()},add_messages:function(step_container,message_html){step_container.find(".js_cart_checkout_box_messages").html(message_html),this.scroll_to(step_container)},clear_messages:function(step_container){step_container.find(".js_cart_checkout_box_messages").empty()},scroll_to:function(element){$("html, body").animate({scrollTop:element.offset().top-10},500)},display_error_msgs:function(return_data,step_container,verify_error){if(return_data.redirect)return window.location=return_data.redirect,!1;var message_html;message_html=return_data.message_html?return_data.message_html:this.error_template({error:verify_error}),this.add_messages(step_container,message_html)},view_product:function(e){window.location=$(e.target).closest(".js_col_name").data("view-url")},add_shipping_test_values:function(e){e.preventDefault();var shipping_form=this.$(".js_cart_checkout_form_shipping");shipping_form.find("input[data-cart_shipping_field=first_name]").val("John"),shipping_form.find("input[data-cart_shipping_field=last_name]").val("Smith"),shipping_form.find("input[data-cart_shipping_field=phone][name*=area_code]").val("403"),shipping_form.find("input[data-cart_shipping_field=phone][name*=exchange]").val("875"),shipping_form.find("input[data-cart_shipping_field=phone][name*=line]").val("4348"),shipping_form.find("input[data-cart_shipping_field=email]").val("test@example.com"),shipping_form.find("input[data-cart_shipping_field=company]").val("Test Company"),shipping_form.find("input[data-cart_shipping_field=address_1]").val("123 1st Street"),shipping_form.find("input[data-cart_shipping_field=municipality]").val("Calgary"),shipping_form.find("select[data-cart_shipping_field=state_id]").val(1),shipping_form.find("input[data-cart_shipping_field=postal_code]").val("T8M 3D9"),shipping_form.find("select[data-cart_shipping_field=country_id]").val(40)},add_billing_test_values:function(e){e.preventDefault();var billing_form=this.$(".js_cart_checkout_form_billing");billing_form.find("input[data-cart_billing_field=first_name]").val("John"),billing_form.find("input[data-cart_billing_field=last_name]").val("Smith"),billing_form.find("input[data-cart_billing_field=phone][name*=area_code]").val("403"),billing_form.find("input[data-cart_billing_field=phone][name*=exchange]").val("875"),billing_form.find("input[data-cart_billing_field=phone][name*=line]").val("4348"),billing_form.find("input[data-cart_billing_field=email]").val("test@example.com"),billing_form.find("input[data-cart_billing_field=company]").val("Test Company"),billing_form.find("input[data-cart_billing_field=address_1]").val("123 1st Street"),billing_form.find("input[data-cart_billing_field=municipality]").val("Calgary"),billing_form.find("select[data-cart_billing_field=state_id]").val(1),billing_form.find("input[data-cart_billing_field=postal_code]").val("T8M 3D9"),billing_form.find("select[data-cart_billing_field=country_id]").val(40)},add_credit_card_test_values:function(e){var credit_card_vals=JSON.parse($(e.target).val());this.$(".js_cart_checkout_credit_card_number").val(credit_card_vals.card_number),this.$(".js_cart_checkout_credit_card_security_code").val(credit_card_vals.security_code),this.$(".js_cart_checkout_credit_card_expiry_date_month").val(credit_card_vals.expiry_date_month),this.$(".js_cart_checkout_credit_card_expiry_date_year").val(credit_card_vals.expiry_date_year)}}),cart_public_app.views.order=Backbone.View.extend({el:$(".js_view_order"),events:{"click .js_col_name":"view_product"},view_product:function(e){var col_name,target=$(e.target);col_name=target.is(".js_col_name")?target:target.closest(".js_col_name"),window.location=col_name.data("view-url")}}),cart_public_app.views.summary=Backbone.View.extend({template:Handlebars.compile('<span class="cart_summary_section js_cart_summary_items">{{product_count}}</span><span class="cart_summary_section js_cart_summary_total">{{total}}</span>'),template_empty:Handlebars.compile('<span class="cart_summary_section js_cart_summary_empty">Your cart is empty.</span>'),events:{click:"open_summary_details"},data:{product_count:0,total:0,total_formatted:"$0.00"},retrieve:function(){return cart_public_app.has_summary?(this.loading(),cart_public_app.ajax_action("load_summary",{},{done:function(return_data){xm.process_ajax(return_data)?(cart_public_app.summary.data.product_count=return_data.product_count,cart_public_app.summary.data.total=return_data.total,cart_public_app.summary.data.total_formatted=return_data.total_formatted,cart_public_app.summary.render()):cart_public_app.summary.failed()},fail:function(return_data){xm.process_ajax(return_data),cart_public_app.summary.failed()}}),this):this},failed:function(){this.remove_loading()},loading:function(){this.remove_loading(),this.$el.width(this.$el.width()),this.$el.find(".js_cart_summary_items, .js_cart_summary_total, .js_cart_summary_empty").remove(),this.$el.append('<span class="js_loading">Loading...</span>')},remove_loading:function(){this.$el.find(".js_loading").remove()
},render:function(){this.remove_loading(),this.$el.append(this.data.product_count>0?this.template({product_count:this.data.product_count+" item"+(1!=this.data.product_count?"s":""),total:this.data.total_formatted}):this.template_empty()),this.$el.width("auto")},open_summary_details:function(){cart_public_app.summary_details||(cart_public_app.summary_details=new cart_public_app.views.summary_details,cart_public_app.order_products_summary=(new cart_public_app.collections.order_products_summary).retrieve(),this.$el.addClass("cart_summary_is_open"),this.scroll_to_summary(),setTimeout(function(){$("html").one("click",cart_public_app.summary.outside_summary_details_click)},250))},scroll_to_summary:function(){window.scrollTo(0,0)},outside_summary_details_click:function(e){0!==cart_public_app.summary_details.$el.has(e.target).length||cart_public_app.summary_details.$el.is(e.target)||cart_public_app.summary.close_summary_details()},close_summary_details:function(){cart_public_app.summary_details&&(cart_public_app.summary_details.remove(),delete cart_public_app.summary_details),cart_public_app.summary.$el.removeClass("cart_summary_is_open"),$("html").off("click",cart_public_app.summary.outside_summary_details_click)}}),cart_public_app.views.summary_details=Backbone.View.extend({className:"cart_summary_details js_cart_summary_details",cart_template:Handlebars.compile('<div class="cart">{{{product_table}}}<div class="cart_actions"><div class="cart_actions_left"><a href="" class="js_cart_summary_close">Close</a></div><div class="cart_actions_center"><a href="{{cart_view_url}}" class="js_close_summary_details">View Cart</a></div><div class="cart_actions_right"><button class="js_cart_checkout">Checkout</button></div></div></div>'),events:{"click .js_cart_summary_close":"close_summary_details","click .js_cart_checkout":"start_checkout"},summary_el:null,set_data:function(data){return this.options||(this.options={}),this.collection=data.collection,this.options.order=data.order,this.options.view_totals=data.view_totals,this},retrieve:function(){return this.render(),this},loading:function(){this.position_el()},position_el:function(){this.summary_el||(this.summary_el=cart_public_app.summary.$el),this.$el.html(cart_public_app.loading_template()),this.summary_el.parent().append(this.$el);var summary_pos=this.summary_el.position();return this.$el.css({left:this.calculate_el_left_position(summary_pos)+"px",top:this.calculate_el_top_position(summary_pos)+"px"}),this},calculate_el_left_position:function(summary_pos){return summary_pos.left+parseInt(this.summary_el.width(),10)-parseInt(this.$el.width(),10)-12},calculate_el_top_position:function(summary_pos){return summary_pos.top+parseInt(this.summary_el.height(),10)-2},render:function(){if(this.$el.is(":visible")&&this.position_el(),this.collection.size()>0){this.$el.html(this.cart_template({cart_route_prefix:cart_config.route_prefix,cart_view_url:cart_config.cart_view_url,product_table:this.options.order.get("donation_cart")?cart_public_app.cart_donation_list_template:cart_public_app.cart_product_list_template}));var table=this.$(".js_cart_product_list tbody");this.collection.forEach(function(order_product){table.append(new cart_public_app.views.cart_product({model:order_product,donation_cart:this.options.order.get("donation_cart")}).render().el)},this),table.append(this.options.view_totals.render().el.innerHTML)}else this.$el.html(cart_public_app.empty_cart_template());return this},cart_empty:function(e){e.preventDefault(),this.loading(),this.undelegateEvents(),cart_public_app.ajax_action("cart_empty",{},{context:this,fail:function(return_data){xm.process_ajax(return_data),this.failed(),setTimeout(function(){cart_public_app.update_cart()},2e3)}})},start_checkout:function(){cart_public_app.start_checkout()},failed:function(){this.$el.html(cart_public_app.error_template({error:"There was a problem loading your cart. Please try again later."}))},close_summary_details:function(e){e.preventDefault(),e.stopPropagation(),cart_public_app.summary.close_summary_details()}}),cart_public_app.views.totals=Backbone.View.extend({total_template:Handlebars.compile('<tr class="total_row{{#if is_grand_total}} grand_total{{/if}}"><td class="col_name"></td><td class="col_unit_price" colspan="2">{{name}}</td><td class="col_amount">{{total}}</td><td class="col_remove"></td></tr>'),donation_total_template:Handlebars.compile('<tr class="total_row{{#if is_grand_total}} grand_total{{/if}}"><td class="col_name">{{name}}</td><td class="col_amount">{{total}}</td></tr>'),initialize:function(options){this.options||(this.options={}),this.options.order=options.order},render:function(){return this.options.order.get("donation_cart")?this.collection.each(function(total_row){this.$el.append(this.donation_total_template({name:total_row.get("name"),total:total_row.get("value_formatted"),is_grand_total:total_row.get("is_grand_total")}))},this):this.collection.each(function(total_row){this.$el.append(this.total_template({name:total_row.get("name"),total:total_row.get("value_formatted"),is_grand_total:total_row.get("is_grand_total")}))},this),this}}),cart_public_app.router=new(Backbone.Router.extend({routes:{checkout:"checkout",view_order:"view_order","*path":"general"},start:function(){$(".js_cart_summary").length>0&&(cart_public_app.has_summary=!0),$(".js_cart").length>0&&(cart_public_app.has_cart=!0),window.history&&window.history.pushState?Backbone.history.start({pushState:!0,root:"/"+cart_config.route_prefix+"/"}):$(".js_cart_checkout").length>0?this.checkout():this.general()},checkout:function(){cart_public_app.checkout=new cart_public_app.views.checkout({el:$(".js_cart_checkout")}),cart_public_app.has_summary&&$(".js_cart_summary").remove()},general:function(){cart_public_app.has_summary&&this.load_summary(),cart_public_app.has_cart&&this.load_cart(),_.each($(".js_cart_add_product"),function(el){new cart_public_app.views.add_product({el:el})})},view_order:function(){new cart_public_app.views.order},load_summary:function(){cart_public_app.summary||(cart_public_app.summary=new cart_public_app.views.summary({el:$(".js_cart_summary")})),cart_public_app.summary.retrieve()},load_cart:function(){cart_public_app.order_products=(new cart_public_app.collections.order_products).retrieve()}})),$(function(){cart_public_app.router.start()});